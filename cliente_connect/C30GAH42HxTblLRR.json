{
  "createdAt": "2025-03-14T00:12:35.624Z",
  "updatedAt": "2025-03-23T21:12:47.661Z",
  "id": "C30GAH42HxTblLRR",
  "name": "Fluxo Base de Whatsapp - D21D",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "content": "SETAR VARÍÁVEIS\n",
        "height": 600,
        "width": 1940,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1860,
        -400
      ],
      "id": "aaf6de75-0b31-4f9f-a6d9-7c3327177f32",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "d21d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1800,
        -120
      ],
      "id": "b24609b2-dfa2-49b4-9a30-c836d8009f98",
      "name": "Webhook",
      "webhookId": "43605103-f50c-4293-86a4-8a12ce130726"
    },
    {
      "parameters": {
        "content": "FILTROS\n",
        "height": 520,
        "width": 1020,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        100,
        -320
      ],
      "id": "692403a2-7f0c-4819-bd8a-ee2234abe49b",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "197d384d-c4c1-40d0-8ee2-b62e5af3c05c",
              "name": "user.Name",
              "value": "={{ $json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "57233cf4-2452-4455-bccb-ea83e9fca64e",
              "name": "user.Number",
              "value": "={{ $json.body.sender }}",
              "type": "string"
            },
            {
              "id": "e78ef7e8-a0c9-4350-9060-93e503e6e16c",
              "name": "message.Sender",
              "value": "={{ $json.body.data.key.remoteJid }}\n\n",
              "type": "string"
            },
            {
              "id": "11c94d0a-7238-4e75-b0d4-ce004f01a53b",
              "name": "fromMe",
              "value": "={{ $json.body.data.key.fromMe ? 'outgoing' : 'incoming' }}",
              "type": "string"
            },
            {
              "id": "9fa17f5a-6ea4-47b4-b2ba-f419fa32bd1d",
              "name": "message.ContentAudio",
              "value": "={{ $json.body.data.message.audioMessage.mimetype }}",
              "type": "string"
            },
            {
              "id": "080aa96e-9226-44df-b631-1e9fde687b96",
              "name": "message.ContentTexto",
              "value": "={{ $json.body.data.message.conversation }}",
              "type": "string"
            },
            {
              "id": "05a34ef6-b52f-47be-a05c-a43422685f91",
              "name": "message.Type",
              "value": "={{ $json.body.data.messageType }}",
              "type": "string"
            },
            {
              "id": "729b66e5-b9c6-4e33-a24f-206f7d46f3f4",
              "name": "message.ID",
              "value": "={{ $json.body.data.key.id }}",
              "type": "string"
            },
            {
              "id": "03ccb2c8-2b94-4bd4-90f0-de118a00706f",
              "name": "message.timestamp",
              "value": "={{ $json.body.data.messageTimestamp }}",
              "type": "number"
            },
            {
              "id": "54ca0173-3d29-40a9-83e5-91ffe2f68580",
              "name": "message.Mimetype",
              "value": "={{ $json.body.data.message.audioMessage.mimetype }}",
              "type": "string"
            },
            {
              "id": "a10a52fe-1469-4c41-a789-29ddeafdebf0",
              "name": "message.TimeOut",
              "value": "10",
              "type": "string"
            },
            {
              "id": "1ae0bf16-ba78-402d-bfe1-91315cc3cf1f",
              "name": "message.Atendimento",
              "value": "720",
              "type": "string"
            },
            {
              "id": "ec98d971-219d-47be-80af-d1c8d389d3cc",
              "name": "apiToken",
              "value": "={{ $json.body.apikey }}",
              "type": "string"
            },
            {
              "id": "8bee3b72-d27c-4427-883e-823de5e9bd86",
              "name": "apiBaseURL",
              "value": "https://primary-production-1821.up.railway.app",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1600,
        -120
      ],
      "id": "5cf627eb-e32d-445a-aaa5-833f5b25cd87",
      "name": "SET_VARIAVEIS"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e543a6db-34dd-4dc7-bfe2-bac2b5d0a614",
              "leftValue": "={{ $('SET_VARIAVEIS').item.json.fromMe }}",
              "rightValue": "incoming",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        200,
        -120
      ],
      "id": "c7e382b7-268f-4ec9-b5d7-6ece3e0f8ac0",
      "name": "INCOMING?"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=atendimento:{{ $json.user.Number }}",
        "value": "true",
        "expire": true,
        "ttl": "={{ $('SET_VARIAVEIS').item.json.message.AtendimentoHumano }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        540,
        40
      ],
      "id": "2b89a56e-cd4e-4ad0-9d02-15767dcb149d",
      "name": "SET_ATENDIMENTO",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "atendimento",
        "key": "=atendimento.{{ $('SET_PAYLOAD').item.json.user.Number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        540,
        -280
      ],
      "id": "e7fc5866-70ef-4110-ac34-c45f6d9ab3ab",
      "name": "GET_ATENDIMENTO",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e4a279cb-3b64-410b-a8b9-873e10acbdd6",
              "leftValue": "={{ $json.atendimento }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        760,
        -280
      ],
      "id": "99c21a6b-6973-4273-9398-fc726048a874",
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        840,
        40
      ],
      "id": "6870a423-4076-49fc-8e8a-ce6e5054e3c9",
      "name": "ESPERAR"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2ce32791-d1f5-41f7-9bb8-3eb1e1097575",
              "name": "base64",
              "value": "={{ $('Webhook').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1160,
        -380
      ],
      "id": "51f60788-3f85-4afe-84de-036b904bd287",
      "name": "EXTRAI_BASE64"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.Type }}",
                    "rightValue": "audioMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "49e69490-7950-4c8b-ad0d-99d706bc0537"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "87508378-704a-4b8c-82bc-9d64696c6c16",
                    "leftValue": "={{ $json.message.Type }}",
                    "rightValue": "conversation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dbb1f51d-6e8b-421c-aaa6-951f9f45a867",
                    "leftValue": "={{ $json.message.Type }}",
                    "rightValue": "document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "de54aefd-528b-4f83-9aee-a7bd788d896a",
                    "leftValue": "={{ $json.message.Type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2fcad5f4-6332-4bc6-aeb4-9ab55e91419f",
                    "leftValue": "={{ $json.message.Type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1400,
        -160
      ],
      "id": "42b3f8b4-87b1-444c-8bf2-ca85569a92bd",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base64",
        "options": {
          "fileName": "audioOGG",
          "mimeType": "=audio/ogg"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -1000,
        -380
      ],
      "id": "4fd7b155-22fd-4de5-bb48-739389c5ed26",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -360,
        -160
      ],
      "id": "780edf01-d722-4ab5-bf9d-87af7e16faf2",
      "name": "Merge"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -820,
        -380
      ],
      "id": "0b31d863-6693-40f7-84d0-9b0790346360",
      "name": "TRANSCREVER_AUDIO",
      "credentials": {
        "openAiApi": {
          "id": "Ug76Jt0WOP7E4x1r",
          "name": "OpenAi - Connecta"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2e3595b1-a095-4762-909f-e3b0a12734de",
              "name": "user.Message",
              "value": "={{ $json.payload }}",
              "type": "string"
            },
            {
              "id": "c3c040e4-465d-4de6-95a7-cd86585bb6cb",
              "name": "user.Number",
              "value": "={{ $('Switch').item.json.message.Sender }}",
              "type": "string"
            },
            {
              "id": "3a19f6e5-92e9-448b-98ec-1d445466ecb6",
              "name": "message.Timestamp",
              "value": "={{ $('Switch').item.json.message.timestamp }}",
              "type": "string"
            },
            {
              "id": "3727f105-a785-48f7-a34a-f4175918cd61",
              "name": "message.ID",
              "value": "={{ $('Switch').item.json.message.ID }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -120,
        -120
      ],
      "id": "df2f2cca-4bc7-4833-a310-da1463af5bd0",
      "name": "SET_PAYLOAD"
    },
    {
      "parameters": {
        "content": "ESPERANDO MENDAGEM\n",
        "height": 660,
        "width": 1500,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1120,
        -420
      ],
      "id": "d8a8a6b7-8a49-4b1d-bffe-47689432272b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "=temp.{{ $('SET_PAYLOAD').item.json.user.Number }}",
        "messageData": "={{ JSON.stringify($('SET_VARIAVEIS').item.json.message) }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1280,
        -200
      ],
      "id": "035a289b-a2a5-4d26-ae26-9da997b0e046",
      "name": "PUSH",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "messages",
        "key": "=temp.{{ $('SET_PAYLOAD').item.json.user.Number }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1460,
        -200
      ],
      "id": "4e8f684b-6e04-45b6-97d0-a6f816d27227",
      "name": "GET",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($('GET').item.json.messages?.first() || '{}').ID }}",
                    "rightValue": "={{ $('SET_VARIAVEIS').item.json.message.ID }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "cc9fe878-645b-44d0-8e5f-c53ecf9e9863"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f5830cee-4806-44c6-9c32-78ad726edc91",
                    "leftValue": "={{ DateTime.fromSeconds(JSON.parse($('GET').item.json.messages[$('GET').item.json.messages.length - 1]).timestamp, { zone: 'America/Sao_Paulo' }).minus({ hours: 3 }).plus({ hours: 3 }).toISO() }}\n",
                    "rightValue": "={{$now.minus(15, 'seconds').plus(1, 'hour')}}\n",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Segue"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Espera"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1820,
        -200
      ],
      "id": "4b45c55b-4ae7-4395-8bc2-65d10e52eaa3",
      "name": "SWITCH_BUFFER"
    },
    {
      "parameters": {
        "amount": 15
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2040,
        -20
      ],
      "id": "b48f1cbd-c860-44e9-81bc-d1be98334efb",
      "name": "Wait",
      "webhookId": "9cc1e839-f122-4131-98f3-e0fc6389f829"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=temp.{{ $('SET_PAYLOAD').item.json.user.Number }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        160,
        -600
      ],
      "id": "fcba2a03-5e85-49d4-9e45-c092fcc235e8",
      "name": "PUSH1",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('SET_PAYLOAD').item.json.sessionID }}",
        "messageData": "={{ $('SET_PAYLOAD').item.json.userMessage }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        420,
        -1120
      ],
      "id": "359b417f-42c4-47c4-a274-a7caf05627eb",
      "name": "Push Messages",
      "credentials": {
        "redis": {
          "id": "xOCLtYh6T6QG0qLM",
          "name": "Redis - Connect"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ (() => { \n    const messages = $json.messages || []; // Array de mensagens\n\n    if (messages.length > 0) {\n        try {\n            // Retorna o tipo e o conteúdo inicial da mensagem para depuração\n            let firstMessageEscaped = messages[0];\n            let debugInfo = `Tipo de messages[0]: ${typeof firstMessageEscaped} | Valor: ${firstMessageEscaped}`;\n\n            // Se for string, fazer o parse\n            if (typeof firstMessageEscaped === 'string') {\n                firstMessageEscaped = JSON.parse(firstMessageEscaped);\n                debugInfo += ` | Após primeiro JSON.parse: ${JSON.stringify(firstMessageEscaped)}`;\n            }\n\n            // Se ainda for string, fazer outro parse (caso tenha dupla serialização)\n            let firstMessage = firstMessageEscaped;\n            if (typeof firstMessageEscaped === 'string') {\n                firstMessage = JSON.parse(firstMessageEscaped);\n                debugInfo += ` | Após segundo JSON.parse: ${JSON.stringify(firstMessage)}`;\n            }\n\n            // Retorna o messageId ou debugInfo\n            return firstMessage.messageId || `messageId não encontrado | ${debugInfo}`;\n        } catch (error) {\n            return `Erro no parsing: ${error.message}`;\n        }\n    }\n    \n    return \"Array vazio\";\n})()}}",
                    "rightValue": "={{ $('SET_VARIAVEIS').item.json.messageID }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "0882e4f5-aa91-46be-a73c-386792f7b19b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nothing"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ec3063b2-cc0d-468d-8af2-022500faec37",
                    "leftValue": "={{ \n  (() => {\n    // 1. Acessar o campo `messages` no JSON\n    const messages = $json.messages;\n\n    // 2. Verificar se `messages` existe e é uma array\n    if (!messages || !Array.isArray(messages) || messages.length === 0) {\n      return 'Erro: Campo `messages` está vazio ou ausente.';\n    }\n\n    // 3. Pegar o último item da array\n    const lastItem = messages[messages.length - 1];\n\n    // 4. Verificar se `lastItem` é uma string válida\n    if (!lastItem || typeof lastItem !== 'string') {\n      return 'Erro: Último item não é uma string válida.';\n    }\n\n    // 5. Limpar os caracteres de escape e remover aspas externas\n    const cleanedItem = lastItem\n      .replace(/^\"|\"$/g, '') // Remove aspas externas\n      .replace(/\\\\\"/g, '\"')  // Substitui \\\" por \"\n      .replace(/\\\\\\\\/g, '\\\\'); // Substitui \\\\ por \\\n\n    // 6. Parsear o JSON\n    let parsedItem;\n    try {\n      parsedItem = JSON.parse(cleanedItem);\n    } catch (e) {\n      return `Erro: Não foi possível parsear o JSON do último item (${e.message}).`;\n    }\n\n    // 7. Extrair o campo `messageTimestamp`\n    const timestamp = parsedItem.messageTimestamp;\n    if (!timestamp) {\n      return 'Erro: Campo `messageTimestamp` não encontrado.';\n    }\n\n    // 8. Converter o timestamp para ISO 8601\n    try {\n      return new Date(Number(timestamp)).toISOString();\n    } catch (e) {\n      return 'Erro: Não foi possível converter o timestamp.';\n    }\n  })()\n}}",
                    "rightValue": "={{ \n    (() => {\n        const now = new Date(); // Obtém a data e hora atual\n        now.setSeconds(now.getSeconds() - 30); // Subtrai 30 segundos\n        return `${now.toISOString()}`; // Retorna no formato ISO\n    })() \n}}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Continue"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Wait"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        760,
        -1120
      ],
      "id": "26992a4d-6a33-45d8-b9b4-4d2e9fb5db6d",
      "name": "Verify Buffer Status"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('INCOMING?').item.json.sessionID }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        980,
        -1120
      ],
      "id": "a3dbf5c4-cfa2-4c23-8716-2d091aa4ab58",
      "name": "Delete Buffer",
      "credentials": {
        "redis": {
          "id": "xOCLtYh6T6QG0qLM",
          "name": "Redis - Connect"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        980,
        -1280
      ],
      "id": "f9ab12e1-057f-4a95-9a2a-0ffc78da7a05",
      "name": "Nothing"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "messages",
        "key": "={{ $('SET_VARIAVEIS').item.json.userNumber }}",
        "keyType": "list",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        580,
        -1120
      ],
      "id": "fa2ccbdb-0542-47ff-b671-f4090c6900f0",
      "name": "Get_Messages",
      "credentials": {
        "redis": {
          "id": "xOCLtYh6T6QG0qLM",
          "name": "Redis - Connect"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        260,
        -1120
      ],
      "id": "af66d39a-ad8c-44e7-a8c9-a5c66708f6ec",
      "name": "Wait2",
      "webhookId": "178f389c-a56e-47f7-b247-f704946c9259"
    },
    {
      "parameters": {
        "content": "DELETA MEMÓRIA",
        "height": 320,
        "width": 260,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        140,
        -680
      ],
      "id": "0ea02fca-cc5d-4224-b5ec-76befb26548c",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=temp.{{ $('SET_PAYLOAD').item.json.user.Number }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2040,
        -200
      ],
      "id": "e8bd2e48-44e0-4da3-a94b-a14be14dcb6d",
      "name": "DELETE",
      "credentials": {
        "redis": {
          "id": "68kS7JueUisb4P6J",
          "name": "Redis - d21d"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        2040,
        -360
      ],
      "id": "a4e6b624-c6ad-4418-b954-2cff963c098b",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "content": "# DESAFIO GESTOR DE AGENTES | CRIADOR DIGITAL",
        "height": 80,
        "width": 940,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1860,
        -520
      ],
      "id": "4de1534f-c294-4068-995d-a32394ccfc7a",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b8161c56-ebd6-4af3-a479-57ee3f7fd968",
              "name": "payload",
              "value": "={{ JSON.stringify({ userMessage: $('SET_VARIAVEIS').item.json.message.ContentTexto,\nmessageTimestamp: $('SET_VARIAVEIS').item.json.message.timestamp , messageId: $('SET_VARIAVEIS').item.json.message.ID })}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -640,
        -220
      ],
      "id": "49400aea-29e6-456a-ad1d-41ee5baf89d1",
      "name": "TEXT_DATA"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b8161c56-ebd6-4af3-a479-57ee3f7fd968",
              "name": "payload",
              "value": "={{ JSON.stringify({ userMessage: $json.text,\nmessageTimestamp: $('SET_VARIAVEIS').item.json.messageTimestamp, messageId: $('SET_VARIAVEIS').item.json.messageID })}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -640,
        -380
      ],
      "id": "9977410e-9600-4664-b87b-7592bf7c0886",
      "name": "AUDIO_DATA"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "707f6da9-bec1-4d84-9793-c7b5fb5583f4",
              "name": "message",
              "value": "={{ $('GET').item.json.messages.map(value => { \n    const obj = JSON.parse(value);\n    return obj.Content || obj.ContentTexto || ''; \n}).join('\\n') }}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2260,
        -200
      ],
      "id": "812b160c-ee89-406f-a654-fefa1f0835dd",
      "name": "CONCATENA"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "48762549-d17a-43f4-85f6-66f4a3da5f42",
              "name": "resultado",
              "value": "={{ $json.message }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        -200
      ],
      "id": "b7a4567a-99c6-4c32-bf06-9b1cf2526302",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ac211cab-fe77-4f94-8732-84c4cbbb9312",
              "name": "timestampAtual",
              "value": "={{ DateTime.fromSeconds(JSON.parse($json.messages[$json.messages.length - 1]).timestamp, { zone: 'America/Sao_Paulo' }).minus({ hours: 3 }).plus({ hours: 3 }).toISO() }}",
              "type": "string"
            },
            {
              "id": "78c55c61-7de7-47cf-89dd-f3eec01cfa3d",
              "name": "horarioAtuaMeno15",
              "value": "={{$now.minus(15, 'seconds').plus(1, 'hour')}}",
              "type": "string"
            },
            {
              "id": "c6bf8175-57f0-4929-8a53-2e4a4173ce89",
              "name": "",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1620,
        -380
      ],
      "id": "1f799e9b-653c-4fe1-9c51-b613aacd3795",
      "name": "TESTE"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "SET_VARIAVEIS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET_VARIAVEIS": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "INCOMING?": {
      "main": [
        [
          {
            "node": "GET_ATENDIMENTO",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SET_ATENDIMENTO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET_ATENDIMENTO": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "PUSH",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ESPERAR",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EXTRAI_BASE64": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "EXTRAI_BASE64",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "TEXT_DATA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ],
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "TRANSCREVER_AUDIO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "SET_PAYLOAD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TRANSCREVER_AUDIO": {
      "main": [
        [
          {
            "node": "AUDIO_DATA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET_PAYLOAD": {
      "main": [
        [
          {
            "node": "INCOMING?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PUSH": {
      "main": [
        [
          {
            "node": "GET",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET": {
      "main": [
        [
          {
            "node": "TESTE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SWITCH_BUFFER": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "DELETE",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "GET",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Messages": {
      "main": [
        [
          {
            "node": "Get_Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Buffer Status": {
      "main": [
        [
          {
            "node": "Nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get_Messages": {
      "main": [
        [
          {
            "node": "Verify Buffer Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Push Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO_DATA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEXT_DATA": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DELETE": {
      "main": [
        [
          {
            "node": "CONCATENA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CONCATENA": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TESTE": {
      "main": [
        [
          {
            "node": "SWITCH_BUFFER",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "primary-production-1821.up.railway.app",
            "user-agent": "axios/1.7.9",
            "content-length": "969",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "146.190.59.46",
            "x-forwarded-host": "primary-production-1821.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/us-west1",
            "x-railway-request-id": "Sun57Y_IS6ySlZ46bRsFow_3167001623",
            "x-real-ip": "146.190.59.46",
            "x-request-start": "1742763246562"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.upsert",
            "instance": "Ofir",
            "data": {
              "key": {
                "remoteJid": "5511985401987@s.whatsapp.net",
                "fromMe": false,
                "id": "3EB0DFE2819499C0633162"
              },
              "pushName": "Dival S Filho 😎",
              "status": "DELIVERY_ACK",
              "message": {
                "conversation": "Teste 25",
                "messageContextInfo": {
                  "deviceListMetadata": {
                    "senderKeyHash": "OG65I6BDI4V+0g==",
                    "senderTimestamp": "1742595366",
                    "senderAccountType": "E2EE",
                    "receiverAccountType": "E2EE",
                    "recipientKeyHash": "ey9k2dHOiS12Wg==",
                    "recipientTimestamp": "1742443804"
                  },
                  "deviceListMetadataVersion": 2,
                  "messageSecret": "DXq2HFpNgyvYWSRLebkfphwR8ub1X/ijM2/EeT6XEFg="
                }
              },
              "messageType": "conversation",
              "messageTimestamp": 1742763246,
              "instanceId": "1f617cf7-0352-442c-8759-1dd6a92b586c",
              "source": "web"
            },
            "destination": "https://primary-production-1821.up.railway.app/webhook/d21d",
            "date_time": "2025-03-23T17:54:06.448Z",
            "sender": "5511932081209@s.whatsapp.net",
            "server_url": "https://dinastia-evolution.lfigsi.easypanel.host",
            "apikey": "199604EDFDB7-477B-9F21-8DB8DB4A060D"
          },
          "webhookUrl": "https://primary-production-1821.up.railway.app/webhook/d21d",
          "executionMode": "production"
        }
      }
    ]
  },
  "versionId": "655a417c-6249-457b-8c8c-bff2429890e0",
  "triggerCount": 1,
  "tags": [
    {
      "createdAt": "2025-03-10T16:43:32.633Z",
      "updatedAt": "2025-03-10T16:43:32.633Z",
      "id": "L307GdwEDRROFLG5",
      "name": "Criador Digital"
    },
    {
      "createdAt": "2025-03-17T19:34:03.740Z",
      "updatedAt": "2025-03-17T19:34:03.740Z",
      "id": "M3oF1hF2pAN9SLRE",
      "name": "D21D"
    }
  ]
}